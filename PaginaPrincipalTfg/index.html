<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@700&family=Open+Sans:wght@400&display=swap" rel="stylesheet">
    <!-- Libreria Js Empleada para encriptar contraselas con AES (metodo de alta seguridad) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.9-1-crypto-js.js"></script>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    
    <main class="container">
        <h1 class="mainTitle">Bienvenido a <b>Motor Land</b></h1>
    <h2 class="subTitle">La red Social echa por Amantes del motor, para Amantes del Motor</h2>
    <div class="buttons">
        <button type="button" class="btnLogin">Login</button>
        <button type="button" class="btnRegister">Register</button>
    </div>
    <div>
        <h2>Quien Somos</h2>
        <p>
            Lorem ipsum dolor sit amet consectetur adipisicing elit. Ducimus, ullam ipsum dolorum quaerat repudiandae autem cumque maiores tempore 
            facere itaque non iste corporis debitis molestias perferendis nostrum hic amet voluptatem saepe. Magni, modi dolores aliquid iure saepe impedit ullam quod. 
            Laboriosam aut, dolores cumque atque unde, ipsa tempora similique rem sequi corrupti eaque aliquid quas sint provident error velit minus assumenda, 
            necessitatibus soluta. Nostrum laboriosam fuga illum explicabo neque repudiandae molestias, numquam similique perferendis eius odio quasi quas autem 
            inventore exercitationem maiores culpa? Nesciunt, fuga in alias voluptas officiis ipsa rerum, veniam at aperiam hic consequuntur atque obcaecati deserunt eos?
        </p>
        <p>
            Lorem ipsum dolor sit amet consectetur adipisicing elit. Ducimus, ullam ipsum dolorum quaerat repudiandae autem cumque maiores tempore 
            facere itaque non iste corporis debitis molestias perferendis nostrum hic amet voluptatem saepe. Magni, modi dolores aliquid iure saepe impedit ullam quod. 
            Laboriosam aut, dolores cumque atque unde, ipsa tempora similique rem sequi corrupti eaque aliquid quas sint provident error velit minus assumenda, 
            necessitatibus soluta. Nostrum laboriosam fuga illum explicabo neque repudiandae molestias, numquam similique perferendis eius odio quasi quas autem 
            inventore exercitationem maiores culpa? Nesciunt, fuga in alias voluptas officiis ipsa rerum, veniam at aperiam hic consequuntur atque obcaecati deserunt eos?
        </p>
    </div>
    </main>
</body>

<!-- Modal Login -->
<div id="myModal" class="modal" style="display: none;">
    <div class="modal-content">
        <span class="close">&times;</span>
            <h2>Login</h2>
            <form class="formModal" id="loginForm">
                <input type="text" placeholder="Username" id="usernameLog" required>
                <input type="password" placeholder="Password" id="password" required>
                <input type="submit" value="Login">
            </form>
    </div>
</div>

<!-- Modal de Registro -->
<div id="registerModal" class="modal">
    <div class="modal-content">
        <span class="closeReg">&times;</span>
        <h2>Registro de Usuario</h2>
        <form id="registerForm">
            <!-- Usuario  -->
             <label for="usernameReg">Usuario:</label>
             <input type="text" id="usernameReg" name="usernameReg" required>
            <!-- Nombre -->
            <label for="firstName">Nombre:</label>
            <input type="text" id="firstName" name="firstName" required>

            <!-- Apellidos -->
            <label for="lastName">Apellidos:</label>
            <input type="text" id="lastName" name="lastName" required>

            <!-- Correo Electrónico -->
            <label for="email">Correo Electrónico:</label>
            <input type="email" id="email" name="email" required>

            <!-- Contraseña -->
            <label for="password">Contraseña:</label>
            <input type="password" id="passwordreg" name="password" required>

            <!-- Confirmar Contraseña -->
            <label for="confirmPassword">Confirmar Contraseña:</label>
            <input type="password" id="confirmPassword" name="confirmPassword" required>

            <button type="submit">Registrar</button>
        </form>
    </div>
</div>


<script>
    var modalLog = document.getElementById("myModal");
    var btn = document.querySelector(".btnLogin");
    var spanLog = document.querySelector(".close");

    btn.onclick = function() {
        modalLog.style.display = "block";
    }

    spanLog.onclick = function() {
        modalLog.style.display = "none";
    }

    window.onclick = function(event) {
        if (event.target == modalLog) {
            modalLog.style.display = "none";
        }
    }

    // Función para generar la clave secreta desde el hash MD5 (no recomendado para producción)
    async function generateKeyFromUsername(username) {
    // Preparamos el nombre de usuario para hashear
    let encoder = new TextEncoder();
    let usernameBytes = encoder.encode(username);

    //Generamos hash SHA-256
    let hashBuffer = await window.crypto.subtle.digest("SHA-256", usernameBytes);

    //para poder verlo en consola
    let hashArray = Array.from(new Uint8Array(hashBuffer));
    let hashHex = hashArray.map(byte => byte.toString(16).padStart(2, '0')).join('');
    console.log("Hash SHA-256 del nombre de usuario:", hashHex);

    // Crear una clave AES a partir del hash del nombre de usuario
    return window.crypto.subtle.importKey(
        "raw", //Tipo de clave
        hashBuffer, //Datos de la clave (nombre de usuario convertido a bytes)
        { name: "AES-GCM" }, //Algoritmo
        false, //No puede exportarse
        ["encrypt", "decrypt"] //Usos permitidos
    );
    }


    //Función cifrado AES-GCM
    async function encryptPassword(password, secretKey) {
        let encoder = new TextEncoder();
        let passwordBytes = encoder.encode(password);

        //Generar un valor aleatorio para el nonce (vector de inicialización)
        //let iv = window.crypto.getRandomValues(new Uint8Array(12));  // AES-GCM usa un IV de 12 bytes

        //Definir un IV letante (valor de inicialización fijo)
        let iv = new Uint8Array(12);
        iv.fill(0); 

        //Cifrar la contraseña
        let encryptedData = await window.crypto.subtle.encrypt(
            { name: "AES-GCM", iv: iv },
            secretKey,
            passwordBytes
        );

        return { encryptedData, iv };
    }

    //formulario de login
    document.getElementById("loginForm").onsubmit = async function(event) {
        event.preventDefault();  // Prevenir el comportamiento por defecto (recargar la página)

        let usernameLog = document.getElementById('usernameLog').value;
        //Generamos nuestra clave
        let secretKey = await generateKeyFromUsername(usernameLog);

        //Ciframos la contraseña con AES-GCM y la clave que hemos generado
        let { encryptedData, iv } = await encryptPassword(password.value, secretKey);

        //Convertir el resultado cifrado a un formato que se pueda mostrar o almacenar
        let encryptedPasswordBase64 = btoa(String.fromCharCode(...new Uint8Array(encryptedData)));
        let ivBase64 = btoa(String.fromCharCode(...iv));

        let loginData = {
            username: usernameLog,
            encryptedPassword: encryptedPasswordBase64,  
            iv: ivBase64 
        };

        //Mostramos los datos cifrados y listos para enviar a la base de datos
        console.log("Datos de Login:", JSON.stringify(loginData));

    };

    let modalReg = document.getElementById("registerModal");
    let btnRegister = document.querySelector(".btnRegister");
    let spanClose = document.querySelector(".closeReg");

    btnRegister.onclick = function () {
        modalReg.style.display = "block";
    };

    spanClose.onclick = function () {
        modalReg.style.display = "none";
    };

    window.onclick = function (event) {
        if (event.target === modalReg) {
            modalReg.style.display = "none";
        }
    };

    // Función para manejar el registro
    document.getElementById("registerForm").onsubmit = async function (event) {
        event.preventDefault();

        // Obtener los valores del formulario
        let usernameReg = document.getElementById("usernameReg").value;
        let firstName = document.getElementById("firstName").value;
        let lastName = document.getElementById("lastName").value;
        let email = document.getElementById("email").value;
        
        let password = document.getElementById("passwordreg").value;
        let confirmPassword = document.getElementById("confirmPassword").value;

        // Comprobar que las contraseñas coinciden
        if (password !== confirmPassword) {
            alert("Las contraseñas no coinciden.");
            return;
        }

        //Generamos clave privada
        let secretKey = await generateKeyFromUsername(usernameReg);

        //Ciframos
        let { encryptedData, iv } = await encryptPassword(password, secretKey);

        //Preparamos datos para almacenaje
        let encryptedPasswordBase64 = btoa(String.fromCharCode(...new Uint8Array(encryptedData)));
        let ivBase64 = btoa(String.fromCharCode(...iv));

        //creamos objeto JSON
        let registrationData = {
            username: usernameReg,
            firstName: firstName,
            lastName: lastName,
            email: email,
            encryptedPassword: encryptedPasswordBase64,
            iv: ivBase64
        };

        // Mostramos los datos por consola ya preparados para enviar al servidor
        console.log("Datos de Registro:", JSON.stringify(registrationData));
    };
</script>
</html>